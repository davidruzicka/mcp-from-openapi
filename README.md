# MCP from OpenAPI

Universal MCP server that generates tools from any OpenAPI specification.

## Why This Project?

Transform any OpenAPI specification into MCP tools **without writing code**.
Configure everything via MCP profiles, reduce LLM context pollution, and get production-ready features out of the box.

```
+-------------------+
|     MCP Client    |
| (Claude/IDE etc.) |
+---------+---------+
          |
          v
+--+------+---------+
|  |  MCP Profile   |
|  | (autogenerated |
|  |  if missing)   |
|  +----------------+
|                   |
| MCP Server        |
|                   |
|  +----------------+
|  |  OpenAPI Spec  |
|  |  (YAML/JSON)   |
+--+------+---------+
          |
          v
+---------+---------+
|    Service API    |
+-------------------+
```

## Use Cases

1. **Less Context Pollution**: Fewer tools with filtered response fields through profiles = more relevant context for LLM
2. **Multi-Environment**: Same server, different profiles (dev/staging/prod)
3. **Custom Workflows**: Composite tools for common multi-step operations

More about profiles: [docs/PROFILE-GUIDE.md](https://github.com/davidruzicka/mcp4openapi/blob/main/docs/PROFILE-GUIDE.md).

## Key Features

### Core
- **Any OpenAPI API**: Works with OpenAPI 3.x specifications
- **Profiles**: Create JSON configuration transforming API to MCP tools LLM friendly in profiles
- **Tool Aggregation**: Reduce tool clutter - group related operations in profiles
- **Composite Actions**: Chain API calls into workflows in profiles
- **OAuth 2.0**: Browser-based authentication flow for HTTP transport (see [docs/OAUTH.md](./docs/OAUTH.md))
- **Multi-Auth**: Support multiple auth methods (OAuth + Bearer) with priority-based fallback (see [docs/MULTI-AUTH.md](./docs/MULTI-AUTH.md))
- **Observability**: Structured logging (console/JSON) with profile-aware token redaction, Prometheus metrics

Check example profiles in [profiles/](https://github.com/davidruzicka/mcp4openapi/tree/main/profiles).

## Quick Start

### Configuration File Locations

**Cursor:**
- **Project-Specific:** `.cursor/mcp.json` in your project root
- **Global:** default `~/.cursor/mcp.json` in your home directory (various, platform-dependent location based on current Cursor profile; use `⚙` → `Tools & MCP` → `New MCP Server`)

**VS Code + Copilot:**
- **Project-Specific:** `.vscode/mcp.json` in your project root
- **Global:** `~/.config/Code/User/mcp.json` in your home directory (platform-dependent; use `Ctrl+Shift+P` → `MCP: Open User Configuration`)

**JetBrains IDEs + Copilot:**
- **Project-Specific:** `.idea/mcp.json` in your project root
- **Global:** `~/.config/github-copilot/intellij/mcp.json` (platform-dependent; use GitHub Copilot icon bottom right → `Edit Setting...` → `Model Context Protocol (MCP)` → `Configure`)

**Claude Code:**
- **Project-Specific:** `.claude/mcp.json` in your project root
- **Global:** `~/.claude/mcp.json` in your home directory (platform-dependent)

### Option A: npx

No installation required.

**VS Code + Copilot example:**


Use VS Code dialog to enter access token (recommended for security):

```json
{
    "servers": {
        "mcp4openapi": {
            "command": "npx",
            "args": ["mcp4openapi"],
            "env": {
                "OPENAPI_SPEC_PATH": "path/to/openapi.yaml",
                "API_TOKEN": "${input:api_token}",
                "API_BASE_URL": "https://api.example.com",
                "MCP_PROFILE_PATH": "path/to/mcp-profile.json" //optional
            }
        },
        "inputs": [
            {
                "type": "promptString",
                "id": "api_token",
                "description": "API Authorization Token",
                "password": true
            }
        ]
    }
}
```

_`inputs` section prompts you for the token when the server starts, so environment variables are not needed._

**Cursor example:**

```json
{
    "mcpServers": {
        "mcp4openapi": {
            "command": "npx",
            "args": ["mcp4openapi"],
            "env": {
                "OPENAPI_SPEC_PATH": "path/to/openapi.yaml",
                "API_TOKEN": "${env:API_TOKEN}",
                "API_BASE_URL": "https://api.example.com",
                "MCP_PROFILE_PATH": "path/to/mcp-profile.json" //optional
            }
        }
    }
}
```

#### ⚠️ Prerequisites

- You need `npx` NPM package to be installed.

- Remote MCP server connections in Cursor run in a sandbox that doesn't have access to environment variables. The `mcp-remote` command reads environment variables from `~/.env.mcp` file. Make sure to set your tokens there:

```bash
# ~/.env.mcp
API_TOKEN=your_api_token_here
```

**Claude Code example:**

```bash
claude mcp add --transport stdio mcp4openapi \
  --env API_TOKEN="${API_TOKEN}" \
  --env OPENAPI_SPEC_PATH=path/to/openapi.yaml \
  --env API_BASE_URL=https://api.example.com \
  --env MCP_PROFILE_PATH=path/to/mcp-profile.json \
  -- npx mcp4openapi
# expects API_TOKEN environment variable to be set
```

**JetBrains IDEs + Copilot example:**

```json
{
    "servers": {
        "mcp4openapi": {
            "command": "npx",
            "args": ["mcp4openapi"],
            "env": {
                "OPENAPI_SPEC_PATH": "path/to/openapi.yaml",
                "API_TOKEN": "<api_token>",  // doesn't accept ${API_TOKEN} environment variable
                "API_BASE_URL": "https://api.example.com",
                "MCP_PROFILE_PATH": "path/to/mcp-profile.json" //optional
            }
        }
    }
}
```

### Option B: Docker

See [docs/DOCKER.md](./docs/DOCKER.md) for build, run, authentication modes, production deployment, and security.

## Local Development

**1. Clone & Install:**
```bash
git clone https://github.com/davidruzicka/mcp4openapi.git
cd mcp4openapi
npm install
```

**2. Build:**
```bash
npm run build
```

**3. Configure:**
```bash
cp .env.example .env
# Edit .env with your settings
```

**4. Run:**
```bash
npm start
```

See [docs/HTTP-TRANSPORT.md](./docs/HTTP-TRANSPORT.md) for transport options (stdio vs HTTP) and authentication modes.

## Custom CA Certificates

Node.js has a fixed list of certificate authorities. If your MCP server uses self-signed certificates, you need to configure Node.js to trust them.

### Linux

**Option 1: Disable certificate validation (test only)**

```bash
export NODE_TLS_REJECT_UNAUTHORIZED=0
# Persist for current user
echo 'export NODE_TLS_REJECT_UNAUTHORIZED=0' >> $HOME/.profile
```

**Option 2: Add custom CA to Node.js**

```bash
export NODE_EXTRA_CA_CERTS=$HOME/ca-bundle.pem
# Persist for current user
echo 'export NODE_EXTRA_CA_CERTS="$HOME/ca-bundle.pem"' >> $HOME/.profile
```

### Windows (PowerShell)

**Option 1: Disable certificate validation (test only)**

```powershell
# Session only
$env:NODE_TLS_REJECT_UNAUTHORIZED = "0"
# Persist for current user
setx NODE_TLS_REJECT_UNAUTHORIZED 0
```

**Option 2: Add custom CA to Node.js**

```powershell
# Session only
$env:NODE_EXTRA_CA_CERTS = "$env:USERPROFILE\ca-bundle.pem"
# Persist for current user
setx NODE_EXTRA_CA_CERTS "%USERPROFILE%\ca-bundle.pem"
```

### macOS (zsh/bash)

**Option 1: Disable certificate validation (test only)**

```bash
# Session only
export NODE_TLS_REJECT_UNAUTHORIZED=0
# Persist for current user (zsh)
echo 'export NODE_TLS_REJECT_UNAUTHORIZED=0' >> $HOME/.zshrc
# or for bash
echo 'export NODE_TLS_REJECT_UNAUTHORIZED=0' >> $HOME/.bash_profile
```

**Option 2: Add custom CA to Node.js**

```bash
# Session only
export NODE_EXTRA_CA_CERTS="$HOME/ca-bundle.pem"
# Persist for current user (zsh)
echo 'export NODE_EXTRA_CA_CERTS="$HOME/ca-bundle.pem"' >> $HOME/.zshrc
# or for bash
echo 'export NODE_EXTRA_CA_CERTS="$HOME/ca-bundle.pem"' >> $HOME/.bash_profile
```

## Environment Variables

### Required
- `OPENAPI_SPEC_PATH`: Path to OpenAPI spec (YAML/JSON)
- `API_TOKEN`: API token (default env var name; customizable via `AUTH_ENV_VAR`)
  - **Required for stdio** mode with authenticated APIs
  - **Optional for HTTP** mode with per-session tokens
  - When using no profile mode, auth type is auto-detected from OpenAPI `security` schemes

### Optional - Core
- `MCP_PROFILE_PATH`: Profile JSON path (default: auto-generate tools from OpenAPI spec; warning logged if tool exceeds 60 parameters)
- `MCP_TRANSPORT`: `stdio` (default) or `http`
- `API_BASE_URL`: Override OpenAPI server URL

### Optional - Authentication (No-Profile Mode)
When running without a profile, authentication is automatically configured from OpenAPI spec's `security` schemes:

- `AUTH_ENV_VAR`: Environment variable name for auth token (default: `API_TOKEN`)

**Supported OpenAPI Security Types:**
- **Bearer Token** (`http` with `scheme: bearer`): Uses `Authorization: Bearer <token>` header
- **API Key in Header** (`apiKey` with `in: header`): Uses custom header (e.g., `X-API-Key: <token>`)
- **API Key in Query** (`apiKey` with `in: query`): Adds token to query string (e.g., `?api_key=<token>`)
- **OAuth2/OpenID Connect**: Mapped to bearer token authentication
- **Public APIs**: No authentication if OpenAPI spec has no `security` defined

**Example**: Use custom env var for GitLab token:
```bash
export AUTH_ENV_VAR=GITLAB_TOKEN
export GITLAB_TOKEN=glpat-xxxxxxxxxxxx
export OPENAPI_SPEC_PATH=path/to/openapi.yaml
npm start
```

#### Force Authentication Override
For APIs with incomplete OpenAPI specs (missing `security` definition but requiring authentication):

- `AUTH_FORCE`: Enable force auth override (`true|false`, default: `false`)
- `AUTH_TYPE`: Authentication type: `bearer|query|custom-header` (default: `bearer`)
- `AUTH_HEADER_NAME`: Custom header name (required when `AUTH_TYPE=custom-header`)
- `AUTH_QUERY_PARAM`: Query parameter name (required when `AUTH_TYPE=query`)

**Example**: Force bearer authentication for incomplete spec:
```bash
export AUTH_FORCE=true
export AUTH_TYPE=bearer
export API_TOKEN=your_token_here
export OPENAPI_SPEC_PATH=./incomplete-spec.yaml
npm start
```

**Example**: Force custom header authentication:
```bash
export AUTH_FORCE=true
export AUTH_TYPE=custom-header
export AUTH_HEADER_NAME=X-API-Key
export API_TOKEN=your_api_key_here
npm start
```

**Note**: If OpenAPI spec has `security` defined, it takes precedence over force auth settings.

### Optional - Tool Name Shortening
When generating tools from OpenAPI without a profile, long operation IDs may exceed limits. Configure automatic shortening:

- `MCP_TOOLNAME_MAX`: Maximum tool name length (default: `45`)
- `MCP_TOOLNAME_STRATEGY`: Shortening strategy: `none|balanced|iterative|hash|auto` (default: `none`)
  - `none`: No shortening, only warnings
  - `balanced`: Add parts by importance until unique & meaningful (recommended)
  - `iterative`: Progressively remove noise until under limit (conservative)
  - `hash`: Use verb + resource + hash for guaranteed uniqueness
  - `auto`: Try strategies in order: balanced → iterative → hash
- `MCP_TOOLNAME_WARN_ONLY`: Only warn, don't shorten: `true|false` (default: `true`)
- `MCP_TOOLNAME_MIN_PARTS`: Minimum parts for balanced strategy (default: `3`)
- `MCP_TOOLNAME_MIN_LENGTH`: Minimum length in chars for balanced strategy (default: `20`)

**Example**: Apply balanced shortening (recommended):
```bash
export MCP_TOOLNAME_STRATEGY=balanced
export MCP_TOOLNAME_WARN_ONLY=false
```

**Result** for balanced strategy:
```
putApiV4ProjectsIdAlertManagementAlertsAlertIidMetricImagesMetricImageId
    → put_alert_management_image (26 chars)
deleteApiV4ProjectsIdAlertManagementAlertsAlertIidMetricImagesMetricImageId
    → delete_alert_management_image (26 chars)
```

**Example**: Apply iterative shortening with 30 char limit:
```bash
export MCP_TOOLNAME_STRATEGY=iterative
export MCP_TOOLNAME_WARN_ONLY=false
export MCP_TOOLNAME_MAX=30
```

### Optional - HTTP Transport
- `MCP_HOST`: Bind address (default: `127.0.0.1`; warning logged if non-localhost with empty `ALLOWED_ORIGINS`)
- `MCP_PORT`: Port (default: `3003`)
- `ALLOWED_ORIGINS`: Comma-separated origins (default: empty; supports exact, wildcard `*.domain.com`, CIDR `192.168.1.0/24`)
- `SESSION_TIMEOUT_MS`: Session timeout (default: `1800000` = 30min)
- `HEARTBEAT_ENABLED`: SSE heartbeat (default: `false`)
- `HEARTBEAT_INTERVAL_MS`: Heartbeat interval (default: `30000` = 30s)
- `TOKEN_MAX_LENGTH`: Maximum token length in characters (default: `1000`)

#### HTTP Rate Limiting (Security)
Protect against DoS attacks by limiting request rates per endpoint:

- `HTTP_RATE_LIMIT_ENABLED`: Enable rate limiting (`true|false`, default: `true`)
- `HTTP_RATE_LIMIT_WINDOW_MS`: Rate limit window in milliseconds (default: `60000` = 1 minute)
- `HTTP_RATE_LIMIT_MAX_REQUESTS`: Max requests per window for `/mcp`, `/sse`, `/health` (default: `100`)
- `HTTP_RATE_LIMIT_METRICS_MAX`: Max requests per window for `/metrics` (default: `10`)

**Example**: Enable rate limiting with custom limits:
```bash
export HTTP_RATE_LIMIT_ENABLED=true
export HTTP_RATE_LIMIT_MAX_REQUESTS=200    # 200 req/min for MCP endpoints
export HTTP_RATE_LIMIT_METRICS_MAX=20      # 20 req/min for metrics
```

**Example**: Disable rate limiting (not recommended for production):
```bash
export HTTP_RATE_LIMIT_ENABLED=false
```

**Response when rate limit exceeded**:
```json
{
  "error": "Too Many Requests",
  "message": "Rate limit exceeded. Max 100 requests per 60 seconds."
}
```
HTTP status: `429 Too Many Requests` with `RateLimit-*` headers.

### Optional - Observability
- `LOG_LEVEL`: `debug`, `info` (default), `warn`, `error`
- `LOG_FORMAT`: `console` (default) or `json`
- `METRICS_ENABLED`: Enable Prometheus metrics (default: `false`)
- `METRICS_PATH`: Metrics endpoint (default: `/metrics`)

**Security Note**: 
- Sensitive auth tokens are automatically redacted from logs based on your profile's auth configuration (bearer, query, or custom-header)
- All errors returned to clients are sanitized to generic messages (`Internal error`) while full details are logged server-side

## Profile System

Profile defines which MCP tools from OpenAPI spec are exposed and how to aggregate them.
**Start with existing profiles** from `profiles/` (e.g., GitLab).

**Features:**
- Tool aggregation (group related operations)
- Response field filtering (reduce LLM context)
- Composite actions (chain API calls)
- Rate limiting & retry logic

**Create your own profiles**: See [docs/PROFILE-GUIDE.md](./docs/PROFILE-GUIDE.md)

## Testing & Validation

### Validate Profile
```bash
npm run validate
# Checks: JSON syntax, schema, logic, OpenAPI operations
```

### Validate Schema
```bash
npm run validate:schema
# Validates profile-schema.json itself
```

### Run Tests
```bash
npm test
```

## Troubleshooting MCP

**Cursor:**
1. Open "Output" panel (Ctrl+Shift+U / Cmd+Shift+U)
2. Select "MCP Logs" from dropdown
3. Check for connection errors or authentication issues

**VS Code:**
1. Open "Output" from View menu
2. Select problematic MCP server from dropdown
3. Review MCP tool logs for errors

**JetBrains IDEs:**
1. Open "Help" → "Show Log in <your_explorer>" → "mcp" directory to access MCP log files
2. Check `<your_mcp_server>.log` for MCP-related errors

**Common Issues:**
- **Connection refused:** Check if MCP server is running and accessible
- **Authentication failed:** Verify token is correct and has required permissions
- **Certificate errors:** Configure Node.js to trust custom CA certificates (see [Custom CA Certificates](#custom-ca-certificates))
- **Tool not found:** Verify OpenAPI spec path and profile configuration

## IDE-Specific Documentation

- **Cursor:** [Cursor MCP Guide](https://docs.cursor.com/en/context/mcp)
- **VS Code + Copilot:** [VS Code MCP Servers](https://code.visualstudio.com/docs/copilot/customization/mcp-servers), [GitHub Copilot MCP Guide](https://docs.github.com/en/copilot/how-tos/provide-context/use-mcp/extend-copilot-chat-with-mcp?tool=vscode)
- **JetBrains IDEs + Copilot:** [JetBrains+Copilot MCP Guide](https://docs.github.com/en/copilot/how-tos/provide-context/use-mcp/extend-copilot-chat-with-mcp?tool=jetbrains)

## Documentation

- **[docs/EXAMPLE-GITLAB.md](./docs/EXAMPLE-GITLAB.md)** - Complete GitLab API example with curl commands
- **[docs/PROFILE-GUIDE.md](./docs/PROFILE-GUIDE.md)** - Guide for creating custom profiles
- **[docs/HTTP-TRANSPORT.md](./docs/HTTP-TRANSPORT.md)** - HTTP transport setup and usage
- **[docs/OAUTH.md](./docs/OAUTH.md)** - OAuth 2.0 authentication setup guide
- **[docs/MULTI-AUTH.md](./docs/MULTI-AUTH.md)** - Multi-auth support: OAuth + Bearer tokens
- **[docs/DEPLOYMENT-K8S-OAUTH.md](./docs/DEPLOYMENT-K8S-OAUTH.md)** - Production deployment: Kubernetes + OAuth
- **[docs/DOCKER.md](./docs/DOCKER.md)** - Docker deployment guide
- **`profiles/`** - Example profiles for OpenAPI specs
- **`profile-schema.json`** - JSON Schema for IDE autocomplete

## Project Status

- Core MCP server with tool generation
- stdio transport (MCP SDK)
- HTTP Streamable transport (MCP Spec 2025-03-26)
- Session management & SSE resumability
- Profile system with validation
- Prometheus metrics (HTTP, sessions, tools, API calls)

## Contributing

See [`CONTRIBUTING.md`](./CONTRIBUTING.md) for development guidelines.

## License

[MIT](./LICENSE.md)
